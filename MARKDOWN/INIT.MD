# Правила разработки проекта DONTFLOAT

## Общие принципы

### Архитектура проекта
- **Паттерн**: Использование Command Pattern для операций с аудио
- **UI**: Qt6 с темной темой Fusion по умолчанию
- **Стандарт**: C++17 или выше
- **Структура**: Четкое разделение на include/, src/, ui/, resources/, docs/

### Структура директорий
```
DONTFLOAT/
├── include/          # Заголовочные файлы (.h)
├── src/             # Исходный код (.cpp)
├── ui/              # UI файлы (.ui)
├── resources/       # Ресурсы (иконки, звуки)
├── docs/            # Документация
├── translations/    # Файлы локализации (.ts)
├── thirdparty/      # Сторонние библиотеки
└── build/           # Сборка проекта
```

## Стандарты кодирования

### Именование
- **Классы**: PascalCase (MainWindow, WaveformView)
- **Функции/методы**: camelCase (openAudioFile, updateTime)
- **Переменные**: camelCase (currentPosition, isPlaying)
- **Константы**: UPPER_CASE (QT_MIN_VERSION)
- **Файлы**: snake_case (mainwindow.cpp, waveformview.h)

### Заголовочные файлы
- Всегда используйте include guards: `#ifndef CLASSNAME_H`
- Группируйте includes: Qt, стандартная библиотека, локальные
- Объявляйте слоты в private slots секции
- Используйте forward declarations где возможно

### Исходные файлы
- Реализация в соответствующих .cpp файлах
- Используйте const где возможно
- Предпочитайте ссылки указателям для параметров
- Обрабатывайте ошибки через исключения или возвращаемые значения
- **Неиспользуемые параметры**: Используйте `Q_UNUSED()` для временно неиспользуемых параметров
- **Отключенный код**: Всегда документируйте причины отключения в ISSUES_AND_PLANS.md
- **Заглушки**: Не оставляйте заглушки без плана реализации

## Qt специфичные правила

### UI компоненты
- Используйте Qt Designer для создания .ui файлов
- Наследуйтесь от соответствующих Qt классов
- Используйте Q_OBJECT макрос для классов с сигналами/слотами
- Применяйте Qt стили через QPalette для темной темы

### Сигналы и слоты
- Используйте новые синтаксисы Qt5/6: `connect(sender, &Class::signal, receiver, &Class::slot)`
- Группируйте слоты в private slots секции
- Используйте lambda функции для простых операций

### Ресурсы
- Все ресурсы в resources.qrc файле
- Используйте префикс :/icons/ для иконок
- Поддерживайте SVG формат для масштабируемости

## Архитектурные компоненты

### MainWindow
- Центральный компонент приложения
- Управляет всеми UI элементами
- Обрабатывает загрузку аудио через QMediaPlayer
- Сохраняет настройки через QSettings
- Координирует работу всех подсистем

### WaveformView
- Визуализация звуковой волны
- Отображение меток цикла A и B
- Масштабирование и навигация
- Обработка пользовательского ввода
- Синхронизация с позицией воспроизведения

### PitchGridWidget
- Отображение сетки высот (питч-сетка)
- Синхронизация с WaveformView
- Отображение меток нот
- Адаптивное масштабирование

### BPMAnalyzer
- Анализ BPM с использованием алгоритмов Mixxx
- Детекция битов
- Вычисление отклонений ритма
- Интеграция с системой команд

### KeyAnalyzer
- Анализ тональности аудиофайлов
- Поддержка мажорных и минорных тональностей
- Интеграция с qm-dsp библиотекой

### BeatVisualizer
- Визуализация ударных инструментов
- Цветовое кодирование по типам ударных
- Спектрограмма для анализа частот
- Энергетическая кривая ударных

### WaveformAnalyzer
- Анализ волновой формы аудио
- Интеграция с Mixxx библиотеками
- Обработка аудиоданных для визуализации

### Консольный режим
- Отдельная функция `runConsoleMode()`
- Использование `QCoreApplication` для консольного режима
- Поддержка командной строки с опциями
- Синтетические данные для демонстрации (временно)

## Система сборки

### CMake (предпочтительно)
- Минимальная версия: 3.16
- Стандарт C++: 17
- Qt6 модули: Core, Gui, Widgets, Multimedia, MultimediaWidgets
- Автоматическая обработка Qt файлов: AUTOUIC, AUTOMOC, AUTORCC

### qmake (альтернатива)
- Используйте для совместимости с Qt Creator
- Поддерживайте оба формата сборки
- Синхронизируйте изменения между CMakeLists.txt и .pro файлами

## Обработка аудио

### Поддерживаемые форматы
- WAV, MP3, FLAC
- Частота дискретизации: 44.1 kHz (рекомендуется)
- Битность: 16-bit, 24-bit, 32-bit
- Каналы: Моно, Стерео

### Технические требования
- Декодирование в 32-bit float для точности
- Нормализация аудиоданных
- Асинхронная обработка для производительности
- Эффективное управление памятью

## Интерфейс пользователя

### Темная тема
- Используйте QPalette для настройки цветов
- Цветовая схема: темные тона для комфорта
- Скроллбары: прямые края (не округлые)
- Современный плоский дизайн

### Навигация
- Поддержка горячих клавиш
- Контекстные меню (правый клик)
- Drag & Drop для файлов
- Колесико мыши для масштабирования

### Горячие клавиши
- Пробел: воспроизведение/пауза
- S: остановка
- M: метроном
- A/B: установка меток цикла
- Shift+A/B: удаление меток
- Ctrl+↑/↓: изменение BPM
- Ctrl+G: переключение питч-сетки
- **Визуализация ударных**:
  - Ctrl+M: маркеры ударных
  - Ctrl+S: спектрограмма
  - Ctrl+E: энергия ударных
  - Ctrl+D: отклонения битов

## Локализация

### Файлы переводов
- Используйте Qt Linguist для редактирования
- Поддерживайте русский и английский языки
- Файлы в директории translations/
- Формат: DONTFLOAT_ru_RU.ts, DONTFLOAT_en_US.ts

### Тексты
- Все пользовательские тексты через tr()
- Используйте осмысленные контексты
- Поддерживайте множественные формы

## Тестирование и отладка

### Отладка
- Используйте qDebug() для логирования (только в debug режиме)
- Проверяйте корректность аудиофайлов
- Валидируйте входные параметры
- Обрабатывайте исключения
- **Система логирования**: Настройте уровни логирования (DEBUG, INFO, WARNING, ERROR)
- **Отладочные сообщения**: Удаляйте ненужные qDebug() в продакшене

### Производительность
- Отрисовывайте только видимую область
- Используйте агрегацию сэмплов при масштабировании
- Кэшируйте промежуточные вычисления
- Асинхронная обработка BPM анализа
- **Оптимизация памяти**: Эффективное управление аудиоданными
- **Потоковая обработка**: Для больших аудиофайлов
- **Кэширование**: Промежуточных результатов анализа

## Система команд

### Command Pattern
- AudioCommand: загрузка и сохранение аудио
- BeatFixCommand: исправление отклонений битов
- QUndoStack: управление историей команд
- Поддержка отмены/повтора операций

### Горячие клавиши отмены
- Ctrl+Z: отмена последнего действия
- Ctrl+Y: повтор отмененного действия
- Неограниченная глубина истории
- Валидация возможности отмены

## Настройки

### QSettings
- Автоматическое сохранение настроек
- Организация: DONTFLOAT
- Приложение: DONTFLOAT
- Версия: 0.0.0.1

### Сохраняемые параметры
- BPM трека
- Настройки метронома
- Режим отображения времени
- Размеры окон и элементы интерфейса
- Видимость питч-сетки
- Цветовая схема
- Настройки визуализации ударных
- Выбранный язык интерфейса

## Документация

### Обязательная документация
- README.md: общее описание проекта
- docs/architecture.md: техническая архитектура
- docs/features.md: подробное описание функций
- docs/shortcuts.md: справочник по горячим клавишам

### Правила работы с .md файлами
- **Основное правило**: Все .md файлы для собственных пояснений, рапортов и документации создавать в папке `MARKDOWN/`
- **Пользовательская документация**: Файлы для конечных пользователей размещать в папке `docs/`
- **Исключение**: README.md файлы можно создавать в подпапках проекта, если они нужны для пояснения содержимого конкретной директории
- **При обновлении**: Всегда проверять актуальность информации и синхронизировать изменения между файлами
- **При добавлении новых функций**: Обновлять соответствующие .md файлы в `MARKDOWN/` и `docs/`
- **При исправлении багов**: Обновлять ISSUES_AND_PLANS.md и TROUBLESHOOTING.md в `MARKDOWN/`

### Работа с тестами
- **Основное правило**: Все тестовые файлы, скрипты тестирования и тестовые данные размещать в папке `tests/`
- **Структура тестов**: Следовать существующей структуре в `tests/` с подпапками для разных типов тестов
- **Тестовые файлы**: `.cpp`, `.bat`, `.txt` файлы для тестирования
- **Тестовые данные**: Аудиофайлы для тестирования BPM и других функций
- **Конфигурация**: CMakeLists.txt для настройки системы тестирования

### Отслеживание проблем и недоработок
- **Основное правило**: Для недостатков, недоработок и отключенных функций использовать и вовремя обновлять файл `MARKDOWN/ISSUES_AND_PLANS.md`
- **При обнаружении бага**: Немедленно добавить в раздел "Известные баги" с описанием, статусом и планом исправления
- **При отключении функции**: Добавить в раздел "Неработающие/отключенные фичи" с причиной отключения и планом восстановления
- **При планировании новой функции**: Добавить в раздел "Планы на реализацию" с приоритетом и временными рамками
- **При исправлении проблемы**: Обновить статус на "Исправлено ✅" и добавить описание решения

### Комментарии в коде
- Документируйте публичные методы
- Объясняйте сложную логику
- Используйте Doxygen стиль комментариев
- Поддерживайте актуальность документации
- **Отладочные сообщения**: Удаляйте ненужные `qDebug()` в продакшене, оставляйте только критически важные
- **TODO комментарии**: Всегда документируйте в ISSUES_AND_PLANS.md

## Версионирование

### Git workflow
- Используйте осмысленные сообщения коммитов
- Создавайте ветки для новых функций
- Тестируйте перед мержем в main
- Используйте теги для релизов

### Семантическое версионирование
- Формат: MAJOR.MINOR.PATCH
- MAJOR: несовместимые изменения API
- MINOR: новая функциональность
- PATCH: исправления ошибок

## Безопасность

### Валидация
- Проверяйте корректность аудиофайлов
- Валидируйте входные параметры
- Проверяйте состояние приложения
- Обрабатывайте исключения
- **Валидация полей ввода**: Используйте QValidator для полей BPM и размера такта
- **Проверка форматов**: Валидируйте поддерживаемые аудиоформаты (WAV, MP3, FLAC)

### Восстановление
- Автосохранение состояния
- Создание резервных копий
- Восстановление при сбоях
- Логирование ошибок и событий
- **Обработка ошибок**: Graceful degradation при проблемах с аудио
- **Восстановление настроек**: При сбоях приложения

## Производительность

### Оптимизация
- Отрисовка только видимой области
- Агрегация сэмплов при масштабировании
- Кэширование промежуточных вычислений
- Асинхронная обработка

### Память
- Эффективное управление RAM
- Автоматическая очистка неиспользуемых данных
- Умное кэширование результатов
- Мониторинг использования памяти

## Работа с проектом

### Структура директорий (полная)
```
DONTFLOAT/
├── include/          # Заголовочные файлы (.h)
├── src/             # Исходный код (.cpp)
├── ui/              # UI файлы (.ui)
├── resources/       # Ресурсы (иконки, звуки)
├── docs/            # Пользовательская документация
├── MARKDOWN/        # Техническая документация для разработчиков
├── tests/           # Тесты и тестовые данные
├── translations/    # Файлы локализации (.ts)
├── thirdparty/      # Сторонние библиотеки
├── build/           # Сборка проекта
└── .cursor/         # Настройки Cursor AI
```

### Разделение ответственности
- **`MARKDOWN/`** - техническая документация для разработчиков, архитектура, стандарты кодирования
- **`docs/`** - пользовательская документация, руководства по использованию, скриншоты
- **`tests/`** - все файлы, связанные с тестированием: код, скрипты, данные, конфигурация
- **`MARKDOWN/ISSUES_AND_PLANS.md`** - централизованное отслеживание всех проблем, недоработок и планов
- **`README.md`** - общий обзор проекта с ссылками на все папки

### Обязательные действия при разработке
1. **При обнаружении бага**: Немедленно добавить в ISSUES_AND_PLANS.md
2. **При отключении функции**: Документировать причину и план восстановления
3. **При добавлении новой функции**: Обновить соответствующую документацию
4. **При изменении архитектуры**: Синхронизировать docs/ и MARKDOWN/
5. **При работе с тестами**: Размещать все в папке tests/
6. **При создании документации**: Следовать правилам разделения по папкам

---

*Эти правила должны соблюдаться всеми разработчиками проекта DONTFLOAT для обеспечения консистентности кода и архитектуры.*
