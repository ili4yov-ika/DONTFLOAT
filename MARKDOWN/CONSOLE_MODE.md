# Консольный режим DONTFLOAT

## Обзор

DONTFLOAT поддерживает консольный режим работы для автоматизации и пакетной обработки аудиофайлов без графического интерфейса.

**Текущее ограничение (см. ISSUES_AND_PLANS.md)**: в консольном режиме используется синтетический сигнал (параметр `-f` не загружает файл с диска), анализ BPM может не завершаться. В GUI режиме загрузка файлов и алгоритм Mixxx работают корректно.

## Запуск консольного режима

### Базовый синтаксис
```bash
DONTFLOAT.exe -c -f <путь_к_файлу> [опции]
```

### Обязательные параметры
- **-c, --console**: Запуск в консольном режиме
- **-f, --file**: Путь к аудиофайлу для анализа

### Опциональные параметры
- **--min-bpm**: Минимальный BPM для анализа (по умолчанию: 60)
- **--max-bpm**: Максимальный BPM для анализа (по умолчанию: 200)
- **--mixxx**: Использовать алгоритм Mixxx
- **--fast**: Быстрый анализ
- **--variable-tempo**: Предполагать переменный темп

## Примеры использования

### Базовый анализ
```bash
DONTFLOAT.exe -c -f "C:\Music\song.mp3"
```

### Анализ с алгоритмом Mixxx
```bash
DONTFLOAT.exe -c -f "song.mp3" --mixxx
```

### Анализ с настройками BPM
```bash
DONTFLOAT.exe -c -f "song.mp3" --min-bpm 70 --max-bpm 90
```

### Быстрый анализ
```bash
DONTFLOAT.exe -c -f "song.mp3" --fast
```

### Анализ с переменным темпом
```bash
DONTFLOAT.exe -c -f "song.mp3" --variable-tempo
```

### Комбинированные опции
```bash
DONTFLOAT.exe -c -f "song.mp3" --mixxx --min-bpm 80 --max-bpm 120 --fast
```

## Поддерживаемые форматы

### Аудиоформаты
- **WAV**: Без потерь качества
- **MP3**: Сжатый формат
- **FLAC**: Сжатие без потерь
- **OGG**: Открытый формат
- **AAC**: Продвинутое сжатие

### Технические характеристики
- **Частота дискретизации**: 44.1 kHz (рекомендуется)
- **Битность**: 16-bit, 24-bit, 32-bit
- **Каналы**: Моно, Стерео
- **Длительность**: Без ограничений

## Результаты анализа

### Пример вывода
```
=== Консольный режим DONTFLOAT ===
Анализ файла: example.mp3
Примечание: Используются синтетические данные для демонстрации
Загрузка аудиофайла...
Файл загружен успешно:
  - Размер: 220500 сэмплов
  - Частота дискретизации: 44100 Hz
  - Длительность: 5 секунд

Настройки анализа:
  - Минимальный BPM: 60
  - Максимальный BPM: 200
  - Использовать алгоритм Mixxx: Да
  - Предполагать фиксированный темп: Да
  - Быстрый анализ: Нет

Начинаем анализ BPM...

=== РЕЗУЛЬТАТЫ АНАЛИЗА ===
Определенный BPM: 80.5
Уверенность: 85%
Количество обнаруженных битов: 25
Фиксированный темп: Да
Нерегулярные биты: Нет
Среднее отклонение: 3.2%

Первые 10 битов:
[детальная таблица с временными метками]

=== АНАЛИЗ ЗАВЕРШЕН ===
```

### Структура результатов
- **Определенный BPM**: Основной результат анализа
- **Уверенность**: Процент уверенности в результате
- **Количество битов**: Общее количество обнаруженных битов
- **Фиксированный темп**: Статус постоянства темпа
- **Нерегулярные биты**: Обнаружение нерегулярностей
- **Среднее отклонение**: Среднее отклонение от идеального ритма

## Алгоритмы анализа

### Базовый алгоритм
- Стандартный анализ ритма
- Подходит для большинства треков
- Быстрая обработка
- Хорошая точность для постоянного темпа

### Алгоритм Mixxx
- Продвинутый анализ с использованием алгоритмов Mixxx
- Лучшая точность для сложных треков
- Поддержка переменного темпа
- Более медленная обработка

### Быстрый анализ
- Ускоренный режим для предварительной оценки
- Меньшая точность
- Быстрая обработка
- Подходит для пакетной обработки

## Пакетная обработка

### Обработка нескольких файлов
```bash
# Windows (PowerShell)
Get-ChildItem "C:\Music\*.mp3" | ForEach-Object {
    DONTFLOAT.exe -c -f $_.FullName --mixxx
}

# Linux/macOS (Bash)
for file in /path/to/music/*.mp3; do
    DONTFLOAT.exe -c -f "$file" --mixxx
done
```

### Сохранение результатов
```bash
# Перенаправление вывода в файл
DONTFLOAT.exe -c -f "song.mp3" --mixxx > results.txt

# Добавление к существующему файлу
DONTFLOAT.exe -c -f "song.mp3" --mixxx >> results.txt
```

### Фильтрация результатов
```bash
# Только BPM
DONTFLOAT.exe -c -f "song.mp3" --mixxx | grep "Определенный BPM"

# Только уверенность
DONTFLOAT.exe -c -f "song.mp3" --mixxx | grep "Уверенность"
```

## Автоматизация

### Скрипты Windows (Batch)
```batch
@echo off
echo Анализ всех MP3 файлов в папке...
for %%f in (*.mp3) do (
    echo Анализ: %%f
    DONTFLOAT.exe -c -f "%%f" --mixxx
    echo.
)
echo Анализ завершен.
pause
```

### Скрипты Linux/macOS (Bash)
```bash
#!/bin/bash
echo "Анализ всех MP3 файлов в папке..."
for file in *.mp3; do
    echo "Анализ: $file"
    DONTFLOAT.exe -c -f "$file" --mixxx
    echo
done
echo "Анализ завершен."
```

### PowerShell скрипты
```powershell
# Анализ всех файлов в папке
$files = Get-ChildItem "C:\Music" -Filter "*.mp3"
foreach ($file in $files) {
    Write-Host "Анализ: $($file.Name)"
    & "DONTFLOAT.exe" -c -f $file.FullName --mixxx
    Write-Host ""
}
Write-Host "Анализ завершен."
```

## Обработка ошибок

### Коды возврата
- **0**: Успешное выполнение
- **1**: Ошибка загрузки файла
- **2**: Ошибка анализа
- **3**: Неверные параметры командной строки

### Типичные ошибки
```
Ошибка: Для консольного режима необходимо указать файл с помощью -f
Использование: DONTFLOAT -c -f <путь_к_файлу>
```

```
Ошибка: Не удалось загрузить аудиофайл
Проверьте путь к файлу и формат
```

```
Ошибка: Неверные параметры BPM
Минимальный BPM должен быть меньше максимального
```

## Производительность

### Оптимизация скорости
- Используйте **--fast** для быстрого анализа
- Ограничьте диапазон BPM с помощью **--min-bpm** и **--max-bpm**
- Используйте базовый алгоритм для простых треков

### Оптимизация памяти
- Обрабатывайте файлы по одному
- Используйте быстрый анализ для больших файлов
- Очищайте временные файлы

### Параллельная обработка
```bash
# Обработка файлов параллельно (Linux/macOS)
find /path/to/music -name "*.mp3" | xargs -P 4 -I {} DONTFLOAT.exe -c -f {} --mixxx
```

## Интеграция с другими инструментами

### FFmpeg
```bash
# Извлечение аудио из видео и анализ
ffmpeg -i video.mp4 -vn -acodec mp3 audio.mp3
DONTFLOAT.exe -c -f audio.mp3 --mixxx
```

### SoX
```bash
# Конвертация формата и анализ
sox input.wav output.mp3
DONTFLOAT.exe -c -f output.mp3 --mixxx
```

### Python скрипты
```python
import subprocess
import os

def analyze_bpm(file_path):
    result = subprocess.run([
        'DONTFLOAT.exe', '-c', '-f', file_path, '--mixxx'
    ], capture_output=True, text=True)
    
    if result.returncode == 0:
        # Парсинг результата
        lines = result.stdout.split('\n')
        for line in lines:
            if 'Определенный BPM:' in line:
                bpm = float(line.split(':')[1].strip())
                return bpm
    return None

# Использование
bpm = analyze_bpm('song.mp3')
print(f'BPM: {bpm}')
```

## Настройка окружения

### Переменные окружения
```bash
# Windows
set DONTFLOAT_PATH=C:\Program Files\DONTFLOAT
set PATH=%PATH%;%DONTFLOAT_PATH%

# Linux/macOS
export DONTFLOAT_PATH=/usr/local/bin
export PATH=$PATH:$DONTFLOAT_PATH
```

### Алиасы команд
```bash
# Windows (PowerShell)
Set-Alias bpm "DONTFLOAT.exe -c -f"

# Linux/macOS (Bash)
alias bpm='DONTFLOAT.exe -c -f'
```

## Отладка и диагностика

### Подробный вывод
```bash
# Включение отладочных сообщений Qt
set QT_LOGGING_RULES="*=true"
DONTFLOAT.exe -c -f "song.mp3" --mixxx
```

### Проверка версии
```bash
DONTFLOAT.exe --version
```

### Справка
```bash
DONTFLOAT.exe --help
```

## Лучшие практики

### Организация файлов
- Используйте понятные имена файлов
- Организуйте файлы по папкам
- Создавайте резервные копии

### Обработка результатов
- Сохраняйте результаты в файлы
- Используйте структурированные форматы
- Создавайте отчеты по папкам

### Мониторинг
- Отслеживайте время обработки
- Мониторьте использование памяти
- Логируйте ошибки и предупреждения
