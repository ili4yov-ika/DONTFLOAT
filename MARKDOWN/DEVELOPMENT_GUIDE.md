# Руководство по разработке DONTFLOAT

## Стандарты кодирования

### Именование
- **Классы**: PascalCase (MainWindow, WaveformView)
- **Функции/методы**: camelCase (openAudioFile, updateTime)
- **Переменные**: camelCase (currentPosition, isPlaying)
- **Константы**: UPPER_CASE (QT_MIN_VERSION)
- **Файлы**: snake_case (mainwindow.cpp, waveformview.h)

### Заголовочные файлы
- Всегда используйте include guards: `#ifndef CLASSNAME_H`
- Группируйте includes: Qt, стандартная библиотека, локальные
- Объявляйте слоты в private slots секции
- Используйте forward declarations где возможно

### Исходные файлы
- Реализация в соответствующих .cpp файлах
- Используйте const где возможно
- Предпочитайте ссылки указателям для параметров
- Обрабатывайте ошибки через исключения или возвращаемые значения

## Qt специфичные правила

### UI компоненты
- Используйте Qt Designer для создания .ui файлов
- Наследуйтесь от соответствующих Qt классов
- Используйте Q_OBJECT макрос для классов с сигналами/слотами
- Применяйте Qt стили через QPalette для темной темы

### Сигналы и слоты
- Используйте новые синтаксисы Qt5/6: `connect(sender, &Class::signal, receiver, &Class::slot)`
- Группируйте слоты в private slots секции
- Используйте lambda функции для простых операций

### Ресурсы
- Все ресурсы в resources.qrc файле
- Используйте префикс :/icons/ для иконок
- Поддерживайте SVG формат для масштабируемости

## Структура проекта

### Директории
```
DONTFLOAT/
├── include/          # Заголовочные файлы (.h)
├── src/             # Исходный код (.cpp)
├── ui/              # UI файлы (.ui)
├── resources/       # Ресурсы (иконки, звуки)
├── docs/            # Документация
├── translations/    # Файлы локализации (.ts)
├── tests/           # Тесты
├── thirdparty/      # Сторонние библиотеки
├── build/           # Сборка проекта
└── MARKDOWN/        # Вспомогательная документация
```

### Файлы сборки
- **CMakeLists.txt**: Основной файл CMake
- **DONTFLOAT.pro**: Файл qmake
- **resources.qrc**: Ресурсы Qt

## Система команд (Command Pattern)

### Базовый класс Command
```cpp
class Command {
public:
    virtual ~Command() = default;
    virtual void execute() = 0;
    virtual void undo() = 0;
    virtual QString description() const = 0;
};
```

### AudioCommand
- Загрузка аудиофайлов
- Сохранение результатов
- Валидация форматов

### BeatFixCommand
- Исправление отклонений битов
- Интеграция с QUndoStack
- Поддержка отмены/повтора

## Консольный режим

### Реализация
```cpp
int runConsoleMode(const QString& filePath, const BPMAnalyzer::AnalysisOptions& options) {
    // Создание синтетических данных для демонстрации
    // Анализ BPM
    // Вывод результатов
}
```

### Парсинг командной строки
- Использование QCommandLineParser
- Поддержка опций: -c, -f, --min-bpm, --max-bpm, --mixxx, --fast, --variable-tempo
- Валидация входных параметров

## Система тестирования

### Структура тестов
```
tests/
├── test_bpm/                    # Тестовые аудиофайлы
│   └── example_80BPM.mp3       # Пример файла для тестирования
├── CMakeLists.txt              # Конфигурация CMake для тестов
├── README.md                   # Документация тестов
├── test_bpm_analysis.cpp       # Полная система тестирования BPM
├── simple_synthetic_test.cpp   # Синтетический тест
├── functional_test.bat         # Функциональный тест
├── ui_diagnostic_test.bat      # Диагностика UI
├── color_fix_test.bat          # Тест цветовых схем
└── dark_theme_fix_test.bat     # Тест темной темы
```

### Типы тестов
- **Функциональные**: Проверка GUI и консольного режима
- **BPM тесты**: Тестирование анализа BPM
- **Синтетические**: Тестирование с искусственными данными
- **UI тесты**: Проверка интерфейса и цветовых схем

## Цветовые схемы

### Реализация тем
```cpp
void MainWindow::setColorScheme(const QString& scheme) {
    if (scheme == "dark") {
        // Установка темной палитры
        QPalette darkPalette;
        // ... настройки цветов ...
        qApp->setPalette(darkPalette);
    } else if (scheme == "light") {
        // Установка светлой палитры
        QPalette lightPalette;
        // ... настройки цветов ...
        qApp->setPalette(lightPalette);
    }
    
    // Сохранение настроек
    settings.setValue("colorScheme", scheme);
}
```

### Цветовая палитра
- **Темная тема**: Темные тона с белым текстом
- **Светлая тема**: Светлые тона с черным текстом
- **Сохранение**: Настройки сохраняются в QSettings

## Обработка аудио

### Поддерживаемые форматы
- WAV, MP3, FLAC
- Частота дискретизации: 44.1 kHz
- Битность: 16-bit, 24-bit, 32-bit
- Каналы: Моно, Стерео

### Технические требования
- Декодирование в 32-bit float
- Нормализация аудиоданных
- Асинхронная обработка
- Эффективное управление памятью

## Настройки

### QSettings
```cpp
QSettings settings("DONTFLOAT", "DONTFLOAT");
settings.setValue("colorScheme", "dark");
QString scheme = settings.value("colorScheme", "dark").toString();
```

### Сохраняемые параметры
- BPM трека
- Настройки метронома
- Режим отображения времени
- Размеры окон
- Видимость питч-сетки
- Цветовая схема

## Локализация

### Файлы переводов
- **Русский**: DONTFLOAT_ru_RU.ts
- **Английский**: DONTFLOAT_en_US.ts
- Использование Qt Linguist для редактирования

### Тексты
- Все пользовательские тексты через tr()
- Использование осмысленных контекстов
- Поддержка множественных форм

## Производительность

### Оптимизация
- Отрисовка только видимой области
- Агрегация сэмплов при масштабировании
- Кэширование промежуточных вычислений
- Асинхронная обработка

### Память
- Эффективное управление RAM
- Автоматическая очистка неиспользуемых данных
- Умное кэширование результатов
- Мониторинг использования памяти

## Отладка

### Логирование
- Использование qDebug() для логирования
- Проверка корректности аудиофайлов
- Валидация входных параметров
- Обработка исключений

### Тестирование
- Проверка всех компонентов
- Валидация входных данных
- Тестирование граничных случаев
- Проверка производительности
