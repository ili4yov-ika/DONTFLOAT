# Визуализация отклонений ударных (Beat Deviation Visualization)

## Статус: отключена

**По запросу пользователя отрисовка треугольников отклонений битов отключена.** Вызов `drawBeatDeviations` удалён из `WaveformView::paintEvent`. Код функции сохранён в `BeatVisualizer` — при необходимости визуализацию можно включить снова, вернув вызов в `waveformview.cpp`.

---

## Обзор функции

Визуализация отклонений ударных — это функция, которая показывает отклонения фактических позиций битов от ожидаемых на основе BPM трека. Отклонения отображаются в виде **треугольных областей** с цветовой кодировкой.

## Назначение

- **Визуальный анализ** точности ритма трека
- **Определение проблемных зон** с нестабильным темпом
- **Помощь в выравнивании** битов для идеального ритма
- **Мониторинг качества** BPM-анализа

---

## Технические детали

### Геометрия треугольников

Каждый треугольник имеет **ровно 3 вершины**. Ширина треугольника (расстояние от основания до вершины) **ограничена**, чтобы треугольники не слишком различались по размеру:

- **Максимальная ширина**: 36 px (100%) — `DEVIATION_TRIANGLE_MAX_WIDTH_PX`
- **Минимальная ширина**: 85% от макс (~30.6 px) — `DEVIATION_TRIANGLE_MIN_WIDTH_RATIO = 0.85f`

Фактическое отклонение в пикселях ограничивается этим диапазоном; направление треугольника (влево/вправо) сохраняется по знаку отклонения.

```
Вершина 1: (baseX, topY)     — верхняя точка основания
Вершина 2: (apexX, centerY)  — вершина (острый угол) по центру высоты
Вершина 3: (baseX, botY)     — нижняя точка основания
```

- **baseX** = фактическая позиция бита (где он реально произошёл)
- **apexX** = ожидаемая позиция бита (где он должен был быть по BPM)
- **centerY** = центр высоты виджета

### Направление треугольников

**Растянутая доля** (deviation > 0, бит опоздал):
- Фактическая позиция **правее** ожидаемой
- Треугольник направлен **влево** ◀
- Цвет: **красный**

**Сжатая доля** (deviation < 0, бит ранний):
- Фактическая позиция **левее** ожидаемой
- Треугольник направлен **вправо** ▶
- Цвет: **синий**

---

## Цветовая схема

**Что означают треугольники на волне:** это визуализация **отклонений битов** — показывают, насколько фактическая позиция удара отличается от ожидаемой по BPM. Не путать с оранжевым силуэтом ударных (энергия вокруг битов).

### Красные треугольники (растянутые доли)
Бит пришёл **позже** ожидаемого (доля «растянута»).
- **Яркий красный** `(220, 60, 60)` — выровненные биты
- **Менее насыщенный красный** `(200, 100, 100)` — невыровненные биты

### Синие треугольники (сжатые доли)
Бит пришёл **раньше** ожидаемого (доля «сжата»).
- **Яркий синий** `(60, 60, 220)` — выровненные биты
- **Менее насыщенный синий** `(100, 100, 200)` — невыровненные биты

Яркость зависит от флага `beatsAligned` (были ли биты выровнены функцией автоматического исправления). Раньше бледно-красный `(255, 180, 180)` давал розовый оттенок — заменён на более красный.

---

## Настройки визуализации

### Основные параметры

| Параметр | Тип | По умолчанию | Описание |
|----------|-----|--------------|----------|
| `showBeatDeviations` | bool | true | Показывать треугольники отклонений |
| `deviationThreshold` | float | 0.005 (0.5%) | Минимальное отклонение для отрисовки |
| `deviationAlpha` | int | 100 | Прозрачность треугольников (0-255) |
| `beatsAligned` | bool | false | Были ли биты выровнены |

### Порог отклонений (deviationThreshold)

Треугольники рисуются только если `|deviation| >= deviationThreshold`.

**Рекомендуемые значения:**
- `0.005` (0.5%) — для точных треков (по умолчанию)
- `0.01` (1%) — для обычных треков
- `0.02` (2%) — для показа только значительных отклонений

---

## Реализация

### Основная функция отрисовки

```cpp
void BeatVisualizer::drawBeatDeviations(
    QPainter& painter,
    const QVector<BPMAnalyzer::BeatInfo>& beats,
    const QRectF& rect,
    float bpm,
    int sampleRate,
    float samplesPerPixel,
    int startSample,
    const VisualizationSettings& settings,
    const BeatDeviationColors& colors
)
```

### Алгоритм

1. **Вычисление координат:**
   - `expectedPosition` — ожидаемая позиция бита (от предыдущего бита + интервал)
   - `actualPosition` — фактическая позиция бита
   - Преобразование в экранные координаты (X в пикселях)

2. **Фильтрация:**
   - Пропуск битов с `|deviation| < threshold`
   - Пропуск битов за пределами видимой области
   - Пропуск вырожденных треугольников (distance < 0.5px)

3. **Отрисовка:**
   - Создание `QPolygonF` с 3 вершинами
   - Выбор цвета по типу отклонения и состоянию выравнивания
   - Отрисовка с антиалиасингом

### Оптимизация производительности

**Ключевые оптимизации:**
- Антиалиасинг включается **один раз** для всех треугольников (не в цикле)
- Константы вычисляются **вне цикла** (topY, botY, centerY, rectX, rectWidth)
- Треугольники рисуются **один раз** для всего виджета (не для каждого канала)
- Используются `const` для неизменяемых значений

---

## Интеграция в WaveformView

### Место отрисовки

Треугольники рисуются **после** всех каналов волны, но **до** линий тактов:

```cpp
void WaveformView::paintEvent(QPaintEvent* event)
{
    // 1. Фон
    // 2. Сетка
    // 3. Волна каждого канала
    // 4. Силуэты ударных
    // 5. ⭐ Треугольники отклонений (ЗДЕСЬ)
    // 6. Линии тактов
    // 7. Маркеры
    // 8. Курсор воспроизведения
}
```

### Особенности

- Рисуются **один раз** для всего виджета (не для каждого канала отдельно)
- Используется `fullRect` — прямоугольник всего виджета
- **Без клипа** — треугольники могут выходить за границы каналов

---

## Типичные проблемы и решения

### Треугольники не видны

**Причины:**
1. Отклонения меньше порога → уменьшить `deviationThreshold`
2. Настройка `showBeatDeviations = false` → включить в UI
3. Биты за пределами экрана → проскроллить к другой области

**Решение:**
Временно уменьшить порог до 0.005 (0.5%) и проверить.

### Вместо треугольников рисуются ромбы

**Причина:**
Треугольники рисовались для каждого канала отдельно и накладывались друг на друга.

**Решение:**
Рисовать треугольники **один раз** после цикла по каналам (уже исправлено).

### Плохая производительность

**Причины:**
1. Отладочный вывод в цикле отрисовки
2. `save()`/`restore()` для каждого треугольника
3. Вычисления в цикле

**Решение:**
- Убрать весь `qDebug()` из функций отрисовки
- Вынести `save()`/`restore()` за пределы цикла
- Вычислить константы один раз перед циклом

---

## История изменений

### 2025-02-02: Финальная оптимизация
- ✅ Убраны все qDebug() из функций отрисовки
- ✅ save()/restore() вынесены за пределы цикла
- ✅ Константы вычисляются вне цикла
- ✅ Треугольники рисуются один раз для всего виджета
- ✅ Исправлена проблема с ромбами при стерео
- ✅ Порог по умолчанию уменьшен до 0.5%

### 2025-02-02: Исправление геометрии
- ✅ Треугольники из ровно 3 точек (QPolygonF)
- ✅ Одна общая вершина (apexPoint) для обеих диагоналей
- ✅ Правильное направление в зависимости от знака deviation

### 2025-02-02: Начальная реализация
- ✅ Базовая функция drawBeatDeviations
- ✅ Цветовая схема для растянутых/сжатых долей
- ✅ Интеграция в WaveformView

---

## Дальнейшее развитие

### Возможные улучшения

- [ ] **Диагональные полоски** внутри треугольников (паттерн из `createDiagonalPattern`)
- [ ] **Настройка размера** треугольников через UI
- [ ] **Настройка цветов** через UI
- [ ] **Автоматическая регулировка** порога в зависимости от трека
- [ ] **Статистика отклонений** (средние, максимальные, стандартное отклонение)
- [ ] **Экспорт данных** отклонений в файл

### Интеграция с другими функциями

- Связь с функцией **автоматического исправления битов**
- Визуализация **до/после** исправления
- **Интерактивное редактирование** — клик на треугольник для коррекции бита

---

## Связанные файлы

### Код
- `src/beatvisualizer.cpp` — реализация отрисовки
- `include/beatvisualizer.h` — определения структур и функций
- `src/waveformview.cpp` — интеграция в виджет волны
- `src/bpmanalyzer.cpp` — вычисление отклонений битов

### Документация
- `MARKDOWN/INIT.MD` — общие правила проекта
- `MARKDOWN/ISSUES_AND_PLANS.md` — отслеживание проблем
- `docs/features.md` — описание функций для пользователей

---

*Документ создан: 2025-02-02*
*Последнее обновление: 2025-02-02*
