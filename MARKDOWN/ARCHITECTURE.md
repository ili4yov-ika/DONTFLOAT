# Архитектура проекта DONTFLOAT

## Обзор системы

DONTFLOAT - это аудиоанализатор и корректор BPM, построенный на Qt6 с использованием паттерна Command Pattern.

## Основные компоненты

### MainWindow
- **Роль**: Центральный компонент приложения
- **Ответственность**:
  - Управление всеми UI элементами
  - Обработка загрузки аудио через QMediaPlayer
  - Сохранение настроек через QSettings
  - Координация работы всех подсистем

### WaveformView
- **Роль**: Визуализация звуковой волны
- **Ответственность**:
  - Отображение меток цикла A и B
  - Масштабирование и навигация
  - Обработка пользовательского ввода
  - Синхронизация с позицией воспроизведения

### PitchGridWidget
- **Роль**: Отображение сетки высот (питч-сетка)
- **Статус**: ⚠️ **Отключено по умолчанию** (можно включить через Ctrl+G)
- **Ответственность**:
  - Синхронизация с WaveformView
  - Отображение меток нот
  - Адаптивное масштабирование
  - Вертикальная прокрутка с динамической прозрачностью

### BPMAnalyzer
- **Роль**: Анализ BPM с использованием алгоритмов Mixxx
- **Ответственность**:
  - Детекция битов
  - Вычисление отклонений ритма
  - Интеграция с системой команд

### KeyAnalyzer
- **Роль**: Анализ тональности аудиофайлов
- **Ответственность**:
  - Поддержка мажорных и минорных тональностей
  - Интеграция с qm-dsp библиотекой

### BeatVisualizer
- **Роль**: Визуализация ударных инструментов
- **Ответственность**:
  - Цветовое кодирование по типам ударных
  - Спектрограмма для анализа частот
  - Энергетическая кривая ударных
  - Отображение силуэта ударных поверх волны

### WaveformAnalyzer
- **Роль**: Анализ волновой формы аудио
- **Ответственность**:
  - Интеграция с Mixxx библиотеками
  - Обработка аудиоданных для визуализации
  - FFT анализ
  - Фильтрация сигнала

### MarkerStretchEngine
- **Роль**: Механизм растяжения/сжатия аудио между метками
- **Ответственность**:
  - Привязка меток ко времени загруженного аудио
  - Управление временными трансформациями
  - Интеграция с метками цикла A и B
  - Координация с TimeStretchProcessor

### TimeStretchProcessor
- **Роль**: Обработка временного растяжения аудио
- **Ответственность**:
  - Алгоритмы растяжения/сжатия времени
  - Поддержка тонкомпенсации (pitch correction)
  - Сохранение качества аудио при трансформации
  - Интеграция с системой команд

### TimeUtils
- **Роль**: Утилиты для работы со временем
- **Ответственность**:
  - Конвертация между форматами времени
  - Вычисления временных интервалов
  - Форматирование временных меток
  - Преобразование сэмплов в время и обратно

### MetronomeController
- **Роль**: Независимый контроллер метронома
- **Ответственность**:
  - Синхронизация с BPM трека
  - Управление сильными и слабыми долями
  - Независимая работа от воспроизведения
  - Настройка громкости долей
  - Автоматическая остановка при завершении трека

## Система команд (Command Pattern)

### AudioCommand
- Загрузка и сохранение аудиофайлов
- Валидация форматов
- Обработка ошибок

### BeatFixCommand
- Исправление отклонений битов
- Интеграция с QUndoStack
- Поддержка отмены/повтора

## Консольный режим

### Реализация
- Отдельная функция `runConsoleMode()`
- Использование `QCoreApplication` для консольного режима
- Синтетические данные для демонстрации BPM анализатора

### Командная строка
```bash
DONTFLOAT.exe -c -f <файл> [опции]
```

### Опции
- `--min-bpm`: Минимальный BPM (по умолчанию: 60)
- `--max-bpm`: Максимальный BPM (по умолчанию: 200)
- `--mixxx`: Использовать алгоритм Mixxx
- `--fast`: Быстрый анализ
- `--variable-tempo`: Предполагать переменный темп

## Система тестирования

### Структура тестов
```
tests/
├── test_bpm/           # Тестовые аудиофайлы
├── CMakeLists.txt      # Конфигурация CMake для тестов
├── README.md           # Документация тестов
└── *.bat               # Скрипты запуска тестов
```

### Типы тестов
- **Функциональные тесты**: Проверка GUI и консольного режима
- **BPM тесты**: Тестирование анализа BPM
- **Синтетические тесты**: Тестирование с искусственными данными
- **UI тесты**: Проверка интерфейса и цветовых схем

## Цветовые схемы

### Темная тема (по умолчанию)
- **Окно**: `#353535` (темно-серый)
- **Текст**: `#ffffff` (белый)
- **База**: `#232323` (очень темно-серый)
- **Кнопки**: `#353535` (темно-серый)
- **Выделение**: `#2a82da` (синий)

### Светлая тема
- **Окно**: `#f0f0f0` (светло-серый)
- **Текст**: `#000000` (черный)
- **База**: `#ffffff` (белый)
- **Кнопки**: `#f0f0f0` (светло-серый)
- **Выделение**: `#0078d7` (синий)

## Система сборки

### CMake (предпочтительно)
- Минимальная версия: 3.16
- Стандарт C++: 17
- Qt6 модули: Core, Gui, Widgets, Multimedia, MultimediaWidgets

### qmake (альтернатива)
- Используется для совместимости с Qt Creator
- Поддерживаются оба формата сборки

## Обработка аудио

### Поддерживаемые форматы
- WAV, MP3, FLAC
- Частота дискретизации: 44.1 kHz (рекомендуется)
- Битность: 16-bit, 24-bit, 32-bit
- Каналы: Моно, Стерео

### Технические требования
- Декодирование в 32-bit float для точности
- Нормализация аудиоданных
- Асинхронная обработка для производительности
- Эффективное управление памятью

## Настройки и локализация

### QSettings
- Организация: DONTFLOAT
- Приложение: DONTFLOAT
- Версия: 1.0.0

### Сохраняемые параметры
- BPM трека
- Настройки метронома (громкость сильной/слабой доли)
- Режим отображения времени
- Размеры окон и элементы интерфейса
- Видимость питч-сетки (по умолчанию: скрыта)
- Цветовая схема
- Настройки визуализации ударных
- Выбранный язык интерфейса
- Последний открытый файл

### Локализация
- Поддержка русского и английского языков
- Файлы в директории translations/
- Формат: DONTFLOAT_ru_RU.ts, DONTFLOAT_en_US.ts
