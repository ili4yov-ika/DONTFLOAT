# Неработающие фичи, баги и планы DONTFLOAT

**Последнее обновление**: 2025-10-25

## Обзор

Этот документ содержит информацию о неработающих или отключенных функциях, известных багах и планах на реализацию в проекте DONTFLOAT.

## Неработающие/отключенные фичи

### 1. Интеграция с Mixxx библиотеками

#### Статус: Отключено
**Описание**: Интеграция с библиотеками Mixxx для продвинутого анализа BPM и тональности.

**Код**:
```cpp
#ifdef USE_MIXXX_QM_DSP
// Реализация с использованием Mixxx библиотек
#else
// Заглушки для Mixxx библиотек
#endif
```

**Файлы**:
- `src/bpmanalyzer.cpp` - Анализ BPM с Mixxx
- `src/keyanalyzer.cpp` - Анализ тональности с Mixxx
- `src/waveformanalyzer.cpp` - Анализ волновой формы с Mixxx

**Проблема**: Библиотеки Mixxx не подключены к проекту.

**План реализации**:
1. Добавить библиотеки qm-dsp из Mixxx
2. Настроить CMake/qmake для подключения библиотек
3. Реализовать полноценную интеграцию
4. Протестировать работу с реальными данными

### 2. Визуализация ударных

#### Статус: Временно отключено
**Описание**: Расширенная визуализация ударных в WaveformView.

**Код**:
```cpp
// Запускаем анализ ударных (временно отключено)
// Рисуем спектрограмму (если включена) - временно отключено
// Рисуем маркеры ударных (если включены) - временно отключено
// Рисуем энергетическую кривую ударных (если включена) - временно отключено
```

**Файлы**:
- `src/waveformview.cpp` - Методы визуализации ударных (строки 86, 137, 155, 163)
- `include/waveformview.h` - Заголовки методов (строки 50, 87)

**Проблема**: Функции отключены для исправления сборки.

**План реализации**:
1. Исправить проблемы компиляции
2. Реализовать анализ ударных
3. Добавить визуализацию спектрограммы
4. Реализовать маркеры ударных
5. Добавить энергетическую кривую

### 3. Обновление звука метронома

#### Статус: TODO
**Описание**: Обновление звука метронома в зависимости от выбранного типа.

**Код**:
```cpp
// TODO: Обновить звук метронома в зависимости от выбранного типа
```

**Файлы**:
- `src/mainwindow.cpp` - Функция `showMetronomeSettings()`

**Проблема**: Не реализована логика обновления звука.

**План реализации**:
1. Создать различные звуки метронома
2. Реализовать переключение звуков
3. Добавить настройки в диалог метронома
4. Сохранять выбранный звук в настройках

### 4. Исправление метронома

#### Статус: Исправлено ✅
**Описание**: Метроном не работал из-за зависимости от воспроизведения и проблем с созданием звука.

**Проблемы**:
- Метроном работал только при воспроизведении (`isPlaying && isMetronomeEnabled`)
- Использовалась позиция воспроизведения вместо системного времени
- Сложная логика создания WAV файла
- Отсутствие проверки на nullptr

**Исправления**:
1. Убрана зависимость от `isPlaying` - метроном работает независимо
2. Используется `QDateTime::currentMSecsSinceEpoch()` вместо `mediaPlayer->position()`
3. Упрощено создание звукового файла метронома
4. Добавлена проверка `metronomeSound &&` перед использованием

**Файлы**:
- `src/mainwindow.cpp` - Функции `toggleMetronome()` и `createSimpleMetronomeSound()`
- `tests/metronome_fix_test.bat` - Тест исправления метронома

### 5. Функции локализации

#### Статус: Заглушки
**Описание**: Переключение языка интерфейса.

**Код**:
```cpp
// Пока без функционала - заглушка для будущего
// Пока без функционала - заглушка для будущего
```

**Файлы**:
- `src/mainwindow.cpp` - Функции `setRussianLanguage()` и `setEnglishLanguage()`

**Проблема**: Функции не реализованы, только заглушки.

**План реализации**:
1. Создать файлы переводов (.ts)
2. Реализовать загрузку переводов
3. Добавить переключение языка в настройках
4. Протестировать локализацию

### 6. Валидация полей ввода

#### Статус: Закомментировано
**Описание**: Валидация полей BPM и размера такта.

**Код**:
```cpp
// Настраиваем валидатор для поля BPM
// QValidator* bpmValidator = new QRegularExpressionValidator(
//     QRegularExpression("^\\d{1,4}(\\.\\d{1,2})?$"), this);
// ui->bpmEdit->setValidator(bpmValidator);

// Настраиваем валидатор для поля Размер такта (целое 1..32)
// QValidator* barsValidator = new QRegularExpressionValidator(
//     QRegularExpression("^(?:[1-9]|[12]\\d|3[0-2])$"), this);
// ui->barsEdit->setValidator(barsValidator);
```

**Файлы**:
- `src/mainwindow.cpp` - Конструктор MainWindow

**Проблема**: Валидаторы закомментированы.

**План реализации**:
1. Раскомментировать валидаторы
2. Протестировать работу валидации
3. Добавить обработку ошибок валидации
4. Улучшить пользовательский опыт

### 7. Временные отключения в MainWindow

#### Статус: Временно отключено
**Описание**: Несколько функций временно отключены для исправления сборки.

**Код**:
```cpp
// Временно закомментировано до пересборки UI
// Временно отключено для исправления сборки
```

**Файлы**:
- `src/mainwindow.cpp` - Строки 780, 2917, 2940, 2960, 2980

**Проблема**: Функции отключены для исправления проблем сборки.

**План реализации**:
1. Выяснить причины проблем сборки
2. Исправить зависимости и подключения
3. Восстановить отключенные функции
4. Протестировать работу

### 8. Заглушки Mixxx в заголовочных файлах

#### Статус: Заглушки
**Описание**: Forward declarations для Mixxx интеграции в заголовочных файлах.

**Код**:
```cpp
// Forward declarations for Mixxx integration
// Методы интеграции с Mixxx
// Новые методы для улучшенной визуализации ударных (временно отключены)
```

**Файлы**:
- `include/bpmanalyzer.h` - Forward declarations и методы Mixxx
- `include/waveformanalyzer.h` - Методы интеграции с Mixxx
- `include/keyanalyzer.h` - Методы для работы с Mixxx
- `include/waveformview.h` - Отключенные методы визуализации

**Проблема**: Заглушки не реализованы, библиотеки Mixxx не подключены.

**План реализации**:
1. Подключить библиотеки qm-dsp из Mixxx
2. Реализовать методы интеграции
3. Убрать заглушки и forward declarations
4. Протестировать работу с реальными алгоритмами Mixxx

## Известные баги

### 1. Синтетические данные в консольном режиме

#### Статус: Работает, но не идеально
**Описание**: В консольном режиме используются синтетические данные вместо реальной загрузки файлов.

**Код**:
```cpp
// Простая функция загрузки аудиофайла для консольного режима
// Использует упрощенный подход без connect для избежания проблем компиляции
bool loadAudioFile(const QString& /*filePath*/, QVector<float>& samples, int& sampleRate) {
    // Для демонстрации создаем синтетические данные
    // В реальной реализации здесь должен быть код загрузки файла
    // Параметр filePath пока не используется, но сохранен для совместимости
```

**Проблема**: Параметр `filePath` не используется, файлы не загружаются.

**План исправления**:
1. Реализовать реальную загрузку аудиофайлов
2. Исправить проблемы с `QAudioDecoder` и `connect`
3. Добавить поддержку различных форматов
4. Протестировать с реальными файлами

### 2. Отладочные сообщения в продакшене

#### Статус: Много отладочных сообщений
**Описание**: В коде осталось много отладочных сообщений `qDebug()`.

**Примеры**:
```cpp
qDebug() << "QShortcut Shift+A activated";
qDebug() << "clearLoopStart() called";
qDebug() << "Using detected BPM:" << analysis.bpm;
```

**Проблема**: Отладочные сообщения засоряют вывод.

**План исправления**:
1. Удалить ненужные отладочные сообщения
2. Оставить только критически важные
3. Добавить систему логирования для продакшена
4. Настроить уровни логирования

### 3. Неиспользуемые параметры

#### Статус: Предупреждения компилятора
**Описание**: Несколько функций имеют неиспользуемые параметры.

**Примеры**:
```cpp
Q_UNUSED(options); // Параметр пока не используется, но может понадобиться в будущем
```

**Проблема**: Предупреждения компилятора о неиспользуемых параметрах.

**План исправления**:
1. Использовать параметры или удалить их
2. Добавить `Q_UNUSED` для временно неиспользуемых
3. Реализовать функциональность для используемых параметров

### 4. Избыточные отладочные сообщения

#### Статус: Много отладочных сообщений
**Описание**: В коде осталось много отладочных сообщений `qDebug()` в продакшене.

**Примеры**:
```cpp
qDebug() << "Starting BPM analysis with" << samples.size() << "samples at" << sampleRate << "Hz";
qDebug() << "BPM candidate:" << bpm << "confidence:" << confidence << "threshold:" << threshold;
qDebug() << "QShortcut Shift+A activated";
qDebug() << "clearLoopStart() called";
qDebug() << "Using detected BPM:" << analysis.bpm;
```

**Файлы**:
- `src/bpmanalyzer.cpp` - Множество отладочных сообщений анализа BPM
- `src/mainwindow.cpp` - Отладочные сообщения UI и метронома
- `src/main.cpp` - Отладочные сообщения консольного режима

**Проблема**: Отладочные сообщения засоряют вывод в продакшене.

**План исправления**:
1. Удалить ненужные отладочные сообщения
2. Оставить только критически важные
3. Добавить систему логирования для продакшена
4. Настроить уровни логирования (DEBUG, INFO, WARNING, ERROR)

### 5. Заглушки в консольном режиме

#### Статус: Работает, но не идеально
**Описание**: В консольном режиме используются синтетические данные вместо реальной загрузки файлов.

**Код**:
```cpp
// Простая функция загрузки аудиофайла для консольного режима
// Использует упрощенный подход без connect для избежания проблем компиляции
bool loadAudioFile(const QString& /*filePath*/, QVector<float>& samples, int& sampleRate) {
    // Для демонстрации создаем синтетические данные
    // В реальной реализации здесь должен быть код загрузки файла
    // Параметр filePath пока не используется, но сохранен для совместимости
```

**Файлы**:
- `src/main.cpp` - Функция `loadAudioFile()` для консольного режима

**Проблема**: Параметр `filePath` не используется, файлы не загружаются реально.

**План исправления**:
1. Реализовать реальную загрузку аудиофайлов
2. Исправить проблемы с `QAudioDecoder` и `connect`
3. Добавить поддержку различных форматов
4. Протестировать с реальными файлами

## Планы на реализацию

### Краткосрочные планы (1-2 недели)

#### 1. Исправление консольного режима
- **Приоритет**: Высокий
- **Описание**: Реализовать реальную загрузку аудиофайлов
- **Задачи**:
  - Исправить проблемы с `QAudioDecoder`
  - Добавить поддержку различных форматов
  - Протестировать с реальными файлами
  - Убрать синтетические данные

#### 2. Восстановление отключенных функций
- **Приоритет**: Высокий
- **Описание**: Восстановить временно отключенные функции в MainWindow
- **Задачи**:
  - Выяснить причины проблем сборки
  - Исправить зависимости и подключения
  - Восстановить отключенные функции
  - Протестировать работу

#### 3. Валидация полей ввода
- **Приоритет**: Средний
- **Описание**: Включить валидацию полей BPM и размера такта
- **Задачи**:
  - Раскомментировать валидаторы
  - Протестировать работу
  - Добавить обработку ошибок
  - Улучшить UX

#### 4. Очистка отладочных сообщений
- **Приоритет**: Низкий
- **Описание**: Убрать лишние отладочные сообщения
- **Задачи**:
  - Удалить ненужные `qDebug()`
  - Оставить только важные
  - Добавить систему логирования

### Среднесрочные планы (1-2 месяца)

#### 1. Интеграция с Mixxx
- **Приоритет**: Высокий
- **Описание**: Подключить библиотеки Mixxx для продвинутого анализа
- **Задачи**:
  - Добавить библиотеки qm-dsp
  - Настроить сборку
  - Реализовать интеграцию
  - Протестировать работу

#### 2. Визуализация ударных
- **Приоритет**: Средний
- **Описание**: Реализовать расширенную визуализацию ударных
- **Задачи**:
  - Исправить проблемы компиляции
  - Реализовать анализ ударных
  - Добавить спектрограмму
  - Реализовать маркеры ударных

#### 3. Локализация
- **Приоритет**: Средний
- **Описание**: Реализовать переключение языков
- **Задачи**:
  - Создать файлы переводов
  - Реализовать загрузку переводов
  - Добавить настройки языка
  - Протестировать локализацию

### Долгосрочные планы (3+ месяца)

#### 1. Расширенные алгоритмы анализа
- **Приоритет**: Средний
- **Описание**: Добавить новые алгоритмы анализа BPM и тональности
- **Задачи**:
  - Исследовать новые алгоритмы
  - Реализовать их
  - Добавить настройки выбора алгоритма
  - Протестировать точность

#### 2. Плагинная система
- **Приоритет**: Низкий
- **Описание**: Создать систему плагинов для расширения функциональности
- **Задачи**:
  - Спроектировать API плагинов
  - Реализовать систему загрузки
  - Создать примеры плагинов
  - Документировать API

#### 3. Веб-интерфейс
- **Приоритет**: Низкий
- **Описание**: Создать веб-версию приложения
- **Задачи**:
  - Выбрать технологию (WebAssembly, etc.)
  - Портируем основные функции
  - Создать веб-интерфейс
  - Протестировать производительность

## Технические долги

### 1. Архитектурные проблемы

#### Дублирование кода
- **Проблема**: Повторяющийся код в разных частях приложения
- **Решение**: Вынести общую функциональность в базовые классы

#### Слабая связанность компонентов
- **Проблема**: Компоненты слишком тесно связаны
- **Решение**: Использовать паттерны Observer/Mediator

### 2. Производительность

#### Медленная обработка больших файлов
- **Проблема**: Приложение может тормозить на больших аудиофайлах
- **Решение**: Реализовать потоковую обработку и кэширование

#### Неэффективное использование памяти
- **Проблема**: Высокое потребление памяти при работе с аудио
- **Решение**: Оптимизировать структуры данных и алгоритмы

### 3. Тестирование

#### Недостаточное покрытие тестами
- **Проблема**: Многие функции не покрыты тестами
- **Решение**: Написать unit-тесты для всех компонентов

#### Отсутствие интеграционных тестов
- **Проблема**: Нет тестов взаимодействия компонентов
- **Решение**: Создать интеграционные тесты

## Отслеживание прогресса

### Статусы задач
- 🔴 **Не начато** - Задача не начата
- 🟡 **В работе** - Задача в процессе выполнения
- 🟢 **Завершено** - Задача выполнена
- ⏸️ **Приостановлено** - Задача приостановлена
- ❌ **Отменено** - Задача отменена

### Приоритеты
- 🔥 **Критический** - Блокирует работу
- ⚡ **Высокий** - Важно для функциональности
- 📋 **Средний** - Улучшает пользовательский опыт
- 💡 **Низкий** - Nice to have

## Обновления

### Версия 1.0.0 (Текущая)
- ✅ Консольный режим (с синтетическими данными)
- ✅ Система тестирования
- ✅ Исправление проблем UI
- ✅ Единообразная темная тема
- ✅ Исправление метронома
- ❌ Интеграция с Mixxx
- ❌ Визуализация ударных
- ❌ Реальная загрузка файлов в консольном режиме
- ❌ Восстановление отключенных функций MainWindow
- ❌ Валидация полей ввода

### Версия 1.1.0 (Планируемая)
- 🔄 Реальная загрузка файлов в консольном режиме
- 🔄 Восстановление отключенных функций MainWindow
- 🔄 Валидация полей ввода
- 🔄 Очистка отладочных сообщений
- 🔄 Базовые улучшения производительности

### Версия 1.2.0 (Планируемая)
- 🔄 Интеграция с Mixxx
- 🔄 Визуализация ударных
- 🔄 Локализация
- 🔄 Расширенные настройки
- 🔄 Система логирования

---

*Этот документ обновляется по мере выявления новых проблем и реализации функций.*
