# Архитектура DONTFLOAT

*Версия: 0.0.0.1 · Последнее обновление: февраль 2026*

## Основные компоненты

### MainWindow
- Главное окно приложения
- Управляет UI элементами и их взаимодействием
- Обрабатывает загрузку аудио через `QMediaPlayer`
- Сохраняет настройки через `QSettings`
- Управляет воспроизведением и отображением времени
- Координирует работу всех подсистем
- Обрабатывает горячие клавиши и контекстные меню

### WaveformView
- Визуализация звуковой волны (по каналам, с вертикальным смещением)
- Отображение меток цикла A и B
- Отображение меток сжатия/растяжения (система меток с ромбиками, перетаскивание)
- Делегирование отрисовки отклонений битов и силуэта ударных в `BeatVisualizer` (с клипом по области канала)
- Масштабирование и навигация
- Обработка пользовательского ввода (мышь, клавиатура)
- Синхронизация с позицией воспроизведения
- Поддержка правого клика для панорамирования

### PitchGridWidget
- Отображение сетки высот (питч-сетка)
- Синхронизация с WaveformView
- Отображение меток нот
- Адаптивное масштабирование
- Поля ввода тональности

### BPMAnalyzer
- Анализ BPM с использованием алгоритмов Mixxx (qm-dsp)
- Детекция битов и вычисление ожидаемых позиций (`expectedPosition`) и отклонений (`deviation`)
- Генерация рекомендаций по исправлению
- Интеграция с системой команд (Command Pattern)

### BeatVisualizer
- Статические методы отрисовки: `drawBeatDeviations()` (треугольники отклонений), `drawBeatWaveform()` (силуэт ударных)
- Треугольники: основание на фактической позиции бита, вершина на ожидаемой, одна точка по центру высоты канала
- Настройки через `VisualizationSettings` и `BeatDeviationColors`

### KeyAnalyzer
- Анализ тональности аудиофайлов
- Поддержка мажорных и минорных тональностей
- Интеграция с qm-dsp библиотекой
- Определение уверенности в результате
- Обнаружение смены тональности

## Взаимодействие компонентов

### Загрузка аудио
1. `MainWindow` получает путь к файлу
2. `QAudioDecoder` декодирует данные в float-массивы
3. Данные нормализуются и передаются в `WaveformView`
4. `BPMAnalyzer` анализирует BPM и биты
5. `QMediaPlayer` настраивается для воспроизведения
6. `PitchGridWidget` синхронизируется с новыми данными

### Анализ BPM
1. `BPMAnalyzer` получает аудиоданные
2. Применяются алгоритмы детекции битов Mixxx
3. Вычисляется BPM и отклонения
4. Результаты передаются в `WaveformView` для визуализации
5. `MainWindow` обновляет UI с найденным BPM

### Анализ тональности
1. `KeyAnalyzer` получает аудиоданные
2. Применяются алгоритмы анализа хроматического вектора
3. Определяется основная и вторичная тональность
4. Вычисляется уверенность в результате
5. `MainWindow` отображает результат в полях тональности
6. Пользователь может вручную выбрать тональности через контекстные меню
7. Поддержка модуляции: два поля для основной тональности и модуляции
8. Поля интегрированы в интерфейс питч-сетки для удобства работы

### Навигация
1. Пользователь взаимодействует через:
   - Клики по волне
   - Перетаскивание мышью (левый клик)
   - Правый клик + перетаскивание для панорамирования
   - Скроллбар
   - Клавиши навигации
2. `WaveformView` обновляет смещение и масштаб
3. `PitchGridWidget` синхронизируется с изменениями
4. `MainWindow` синхронизирует позицию воспроизведения

### Управление циклами
1. Пользователь устанавливает метки A/B через:
   - Горячие клавиши A/B
   - Клики по кнопкам
   - Контекстное меню (правый клик)
2. `MainWindow` обрабатывает команды
3. `WaveformView` отображает метки и область цикла
4. При воспроизведении проверяется активность цикла

### Управление метками сжатия/растяжения
1. Пользователь создает метки через:
   - Горячую клавишу M в текущей позиции воспроизведения
   - При создании первой метки автоматически создаются начальная (статичная) и конечная метки
2. `MainWindow` обрабатывает команду создания метки через `QShortcut`
3. `WaveformView` отображает метки как белые вертикальные линии с ромбиками
4. При перетаскивании метки:
   - Вычисляется новая позиция с учетом ограничений соседних меток
   - Пересчитываются **коэффициенты сжатия/растяжения** для соседних участков (только визуальная индикация)
   - Обновляется визуализация ромбиков (синие/красные углы показывают, какие участки **будут** сжаты/растянуты при применении)
   - **Важно**: ни аудио, ни форма волны при перетаскивании не меняются — это только предварительный просмотр
5. В реализации действуют ограничения: нулевая метка статична, минимальный сегмент 50 мс, позиция ограничена соседними метками (см. `MarkerEngine`, `waveformview.cpp`). При сбоях см. MARKDOWN/ISSUES_AND_PLANS.md

### Сжатие/растяжение по меткам

- Реальное применение изменений производится отдельной командой (Ctrl+T — «Применить сжатие-растяжение»)
- `MainWindow` собирает текущее состояние меток (`MarkerData`/`Marker` из `MarkerEngine`) и аудиоданных и вызывает `TimeStretchProcessor::applyMarkerStretch()` с тонкомпенсацией (WSOLA)
- `TimeStretchProcessor` рассчитывает сегменты по меткам и обрабатывает каждый сегмент с сохранением высоты тона; результат записывается во временный WAV и подставляется в `QMediaPlayer`
- Для отмены/повтора используется `TimeStretchCommand` в `QUndoStack` (Ctrl+Z / Ctrl+Y)
- Результат:
  - Обновлённое аудио (новая длина трека)
  - Обновлённый набор меток под новую геометрию (`originalPosition` синхронизируется с `position`)
  - Визуализация волны перерисовывается под новое аудио

### Управление интерфейсом
1. Пользователь переключает видимость питч-сетки через:
   - Меню "Вид" → "Убрать/Показать питч-сетку" (в текущей версии пункт **по умолчанию заблокирован**, так как реализация питч-сетки временно заморожена)
   - Горячую клавишу Ctrl+G (логика может быть отключена или изменена вместе с разморозкой функционала)
2. `MainWindow` обрабатывает команду `togglePitchGrid()`
3. Управляется видимость `pitchGridContainer` в `mainSplitter`
4. При скрытии питч-сетки:
   - Скрывается `pitchGridContainer`
   - Волна заполняет всё доступное пространство
   - Сплиттер настраивается на полноэкранный режим
5. При показе питч-сетки:
   - Восстанавливается `pitchGridContainer`
   - Восстанавливаются пропорции 75%/25%
   - Сплиттер возвращается в нормальный режим

> **Примечание:** На данный момент развитие питч-сетки отложено, UI и код считаются экспериментальными и могут быть изменены или переиспользованы позже.

### Масштабирование
1. Управление через колесико мыши или клавиши
2. `WaveformView` обновляет масштаб (1.0 - 1000.0)
3. `PitchGridWidget` адаптируется к новому масштабу
4. Скроллбар обновляется с учетом масштаба
5. Сохраняется текущая видимая позиция

## Отображение времени

### Временная шкала
- Поддержка режима времени (MM:SS.mmm)
- Обновление в реальном времени
- Синхронизация между WaveformView и PitchGridWidget

### Визуальные элементы
- **Волна**: Индиго цвет с прозрачностью
- **Курсор**: Красный курсор воспроизведения
- **Биты**: Белые линии битов (полупрозрачные)
- **Метки цикла**:
  - Точка A: Зеленая вертикальная линия
  - Точка B: Красная вертикальная линия
  - Область цикла: Полупрозрачная заливка
- **Отклонения битов**: Треугольные области (красные/синие), основание — вертикаль на фактической позиции бита, вершина — на ожидаемой позиции по центру высоты канала. Рисуются при включённой опции и при `|deviation| ≥ 2%`. Отдельно — силуэт ударных (жёлто-оранжевый полигон поверх волны).
- **Питч-сетка**: Сетка высот с метками нот
- **Тема**: Темная тема интерфейса с прямыми краями скроллбаров

## Система команд

### Command Pattern
- `AudioCommand`: Загрузка и сохранение аудио
- `BeatFixCommand`: Исправление отклонений битов
- `TimeStretchCommand`: Отмена/повтор применения сжатия-растяжения по меткам (Ctrl+T)
- `QUndoStack`: Управление историей команд
- Поддержка отмены/повтора (Ctrl+Z / Ctrl+Y)

### Горячие клавиши
- **Основные**: Пробел (воспроизведение), S (стоп), T (метроном)
- **Циклы**: A/B (установка), Shift+A/B (удаление)
- **Навигация**: Стрелки, Ctrl+↑/↓ (BPM)
- **Контекстные меню**: Правый клик на кнопках цикла

## Метроном

### Функциональность
- Синхронизация с BPM трека
- Генерация звуковых сигналов
- Визуальная индикация
- Настраиваемая громкость
- Автоматическое включение/выключение

### Техническая реализация
- `QTimer` для точного тайминга
- `QAudioOutput` для воспроизведения
- Генерация WAV файлов на лету
- Интеграция с системой настроек

## Технические детали

### Масштабирование и прокрутка
- **Масштаб**: 1.0 (100%) до 1000.0 (100000%)
- **Смещение**: 0.0 (начало) до 1.0 (конец)
- **Скроллбар**: Адаптивный размер страницы
- **Сохранение позиции**: Видимая область при масштабировании
- **Панорамирование**: Правый клик + перетаскивание
- **Синхронизация**: WaveformView ↔ PitchGridWidget ↔ ScrollBar
- **Каретки воспроизведения**: Точная синхронизация между волной и питч-сеткой
- **Динамическая прозрачность**: Скроллбар становится почти невидимым (5%) при близости каретки

### Обработка аудио
- **Форматы**: WAV, MP3, FLAC
- **Декодирование**: 32-bit float
- **Нормализация**: Автоматическая по амплитуде
- **Каналы**: Моно/стерео
- **Частота**: 44.1 kHz (рекомендуется)
- **Анализ**: BPM, биты, отклонения (expectedPosition, deviation)
- **Сжатие/растяжение по меткам**: TimeStretchProcessor с тонкомпенсацией (WSOLA), применение по Ctrl+T

### Анализ BPM
- **Алгоритм**: Mixxx onset detection (qm-dsp)
- **Точность**: Высокая для электронной музыки
- **Визуализация**: Треугольные области отклонений (красные — растянутые доли, синие — сжатые), порог по умолчанию 2%; силуэт ударных (жёлто-оранжевый) опционально
- **Рекомендации**: Автоматические предложения исправлений

### Управление циклами
- **Метки**: A (начало), B (конец)
- **Визуализация**: Цветные линии и заливка
- **Управление**: Горячие клавиши, кнопки, контекстное меню
- **Синхронизация**: С позицией воспроизведения
- **Валидация**: Проверка корректности диапазона

### Система меток сжатия/растяжения
- **Метки**: Белые вертикальные линии с ромбиками в центре
- **Визуализация**: Ромбики с цветовыми индикаторами (синие для сжатых, красные для растянутых участков)
- **Управление**: Горячая клавиша M для создания, перетаскивание для изменения позиции
- **Автоматическое создание**: Начальная (статичная) и конечная метки создаются при создании первой метки
- **Коэффициенты**: Отображение коэффициентов сжатия/растяжения между метками
- **Ограничения**: Метки не могут находиться на одной позиции, минимальный сегмент 50 мс, нулевая метка статична; позиция при перетаскивании ограничена соседними метками (реализация в `WaveformView` и структуры `MarkerData`/`Marker` в `MarkerEngine`)

### Оптимизация
- **Отрисовка**: Только видимая область
- **Агрегация**: Сэмплов при масштабировании
- **Кэширование**: Промежуточных вычислений
- **Обновление**: Плавное обновление интерфейса
- **Память**: Эффективное управление аудиоданными
- **Производительность**: Асинхронная обработка BPM

## Визуализация ударных

### Новые возможности
- **Автоматическая детекция ударных**: Классификация ударных инструментов
- **Цветовое кодирование**: Различные цвета для kick, snare, hi-hat, crash, ride, tom
- **Размерное кодирование**: Размер маркеров зависит от энергии ударных
- **Спектрограмма**: Анализ частотных характеристик ударных
- **Энергетическая кривая**: Визуализация энергии ударных во времени

### Горячие клавиши
- **Ctrl+M**: Маркеры ударных
- **Ctrl+S**: Спектрограмма
- **Ctrl+E**: Энергия ударных
- **Ctrl+D**: Отклонения битов

## Консольный режим

### Реализация
- Отдельная функция `runConsoleMode()`
- Использование `QCoreApplication` для консольного режима
- Синтетические данные для демонстрации BPM анализатора

**Ограничение**: В консольном режиме параметр `-f` пока не загружает файл с диска (используется синтетический сигнал), анализ BPM может не завершаться. В GUI режиме загрузка файлов и анализ Mixxx работают корректно. Подробнее — в MARKDOWN/ISSUES_AND_PLANS.md и MARKDOWN/CONSOLE_MODE.md.

### Командная строка
```bash
DONTFLOAT.exe -c -f <файл> [опции]
```

### Опции
- `--min-bpm`: Минимальный BPM (по умолчанию: 60)
- `--max-bpm`: Максимальный BPM (по умолчанию: 200)
- `--mixxx`: Использовать алгоритм Mixxx
- `--fast`: Быстрый анализ
- `--variable-tempo`: Предполагать переменный темп

## Система тестирования

### Структура тестов
```
tests/
├── test_bpm/           # Тестовые аудиофайлы
├── CMakeLists.txt      # Конфигурация CMake для тестов
├── README.md           # Документация тестов
└── *.bat               # Скрипты запуска тестов
```

### Типы тестов
- **Функциональные тесты**: Проверка GUI и консольного режима
- **BPM тесты**: Тестирование анализа BPM
- **Синтетические тесты**: Тестирование с искусственными данными
- **UI тесты**: Проверка интерфейса и цветовых схем

## Цветовые схемы

### Темная тема (по умолчанию)
- **Окно**: `#353535` (темно-серый)
- **Текст**: `#ffffff` (белый)
- **База**: `#232323` (очень темно-серый)
- **Кнопки**: `#353535` (темно-серый)
- **Выделение**: `#2a82da` (синий)

### Светлая тема
- **Окно**: `#f0f0f0` (светло-серый)
- **Текст**: `#000000` (черный)
- **База**: `#ffffff` (белый)
- **Кнопки**: `#f0f0f0` (светло-серый)
- **Выделение**: `#0078d7` (синий)

## Система сборки

### CMake (предпочтительно)
- Минимальная версия: 3.16
- Стандарт C++: 17
- Qt6 модули: Core, Gui, Widgets, Multimedia, MultimediaWidgets

### qmake (альтернатива)
- Используется для совместимости с Qt Creator
- Поддерживаются оба формата сборки

## Настройки и локализация

### QSettings
- Организация: DONTFLOAT
- Приложение: DONTFLOAT
- Версия: 0.0.0.1

### Сохраняемые параметры
- BPM трека
- Настройки метронома
- Режим отображения времени
- Размеры окон и элементы интерфейса
- Видимость питч-сетки
- Цветовая схема

### Локализация
- Поддержка русского и английского языков
- Файлы в директории translations/
- Формат: DONTFLOAT_ru_RU.ts, DONTFLOAT_en_US.ts

## Известные проблемы

### Метки сжатия/растяжения
- В коде реализованы ограничения: минимальный сегмент 50 мс, запрет дубликатов, позиция при перетаскивании ограничена соседними метками (`waveformview.cpp`: `MIN_MARKER_SEGMENT_MS`, проверки в `mouseMoveEvent()` и при добавлении меток).
- При некорректном поведении или сбоях см. MARKDOWN/ISSUES_AND_PLANS.md.
