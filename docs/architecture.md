# Архитектура DONTFLOAT

## Основные компоненты

### MainWindow
- Главное окно приложения
- Управляет UI элементами и их взаимодействием
- Обрабатывает загрузку аудио через `QMediaPlayer`
- Сохраняет настройки через `QSettings`
- Управляет воспроизведением и отображением времени
- Координирует работу всех подсистем
- Обрабатывает горячие клавиши и контекстные меню

### WaveformView
- Визуализация звуковой волны
- Отображение меток цикла A и B
- Визуализация отклонений битов
- Масштабирование и навигация
- Обработка пользовательского ввода (мышь, клавиатура)
- Синхронизация с позицией воспроизведения
- Поддержка правого клика для панорамирования

### PitchGridWidget
- Отображение сетки высот (питч-сетка)
- Синхронизация с WaveformView
- Отображение меток нот
- Адаптивное масштабирование
- Поля ввода тональности

### BPMAnalyzer
- Анализ BPM с использованием алгоритмов Mixxx
- Детекция битов
- Вычисление отклонений ритма
- Генерация рекомендаций по исправлению
- Интеграция с системой команд (Command Pattern)

### KeyAnalyzer
- Анализ тональности аудиофайлов
- Поддержка мажорных и минорных тональностей
- Интеграция с qm-dsp библиотекой
- Определение уверенности в результате
- Обнаружение смены тональности

## Взаимодействие компонентов

### Загрузка аудио
1. `MainWindow` получает путь к файлу
2. `QAudioDecoder` декодирует данные в float-массивы
3. Данные нормализуются и передаются в `WaveformView`
4. `BPMAnalyzer` анализирует BPM и биты
5. `QMediaPlayer` настраивается для воспроизведения
6. `PitchGridWidget` синхронизируется с новыми данными

### Анализ BPM
1. `BPMAnalyzer` получает аудиоданные
2. Применяются алгоритмы детекции битов Mixxx
3. Вычисляется BPM и отклонения
4. Результаты передаются в `WaveformView` для визуализации
5. `MainWindow` обновляет UI с найденным BPM

### Анализ тональности
1. `KeyAnalyzer` получает аудиоданные
2. Применяются алгоритмы анализа хроматического вектора
3. Определяется основная и вторичная тональность
4. Вычисляется уверенность в результате
5. `MainWindow` отображает результат в полях тональности
6. Пользователь может вручную выбрать тональности через контекстные меню
7. Поддержка модуляции: два поля для основной тональности и модуляции
8. Поля интегрированы в интерфейс питч-сетки для удобства работы

### Навигация
1. Пользователь взаимодействует через:
   - Клики по волне
   - Перетаскивание мышью (левый клик)
   - Правый клик + перетаскивание для панорамирования
   - Скроллбар
   - Клавиши навигации
2. `WaveformView` обновляет смещение и масштаб
3. `PitchGridWidget` синхронизируется с изменениями
4. `MainWindow` синхронизирует позицию воспроизведения

### Управление циклами
1. Пользователь устанавливает метки A/B через:
   - Горячие клавиши A/B
   - Клики по кнопкам
   - Контекстное меню (правый клик)
2. `MainWindow` обрабатывает команды
3. `WaveformView` отображает метки и область цикла
4. При воспроизведении проверяется активность цикла

### Управление интерфейсом
1. Пользователь переключает видимость питч-сетки через:
   - Меню "Вид" → "Убрать/Показать питч-сетку"
   - Горячую клавишу Ctrl+G
2. `MainWindow` обрабатывает команду `togglePitchGrid()`
3. Управляется видимость `pitchGridContainer` в `mainSplitter`
4. При скрытии питч-сетки:
   - Скрывается `pitchGridContainer`
   - Волна заполняет всё доступное пространство
   - Сплиттер настраивается на полноэкранный режим
5. При показе питч-сетки:
   - Восстанавливается `pitchGridContainer`
   - Восстанавливаются пропорции 75%/25%
   - Сплиттер возвращается в нормальный режим

### Масштабирование
1. Управление через колесико мыши или клавиши
2. `WaveformView` обновляет масштаб (1.0 - 1000.0)
3. `PitchGridWidget` адаптируется к новому масштабу
4. Скроллбар обновляется с учетом масштаба
5. Сохраняется текущая видимая позиция

## Отображение времени

### Временная шкала
- Поддержка режима времени (MM:SS.mmm)
- Обновление в реальном времени
- Синхронизация между WaveformView и PitchGridWidget

### Визуальные элементы
- **Волна**: Индиго цвет с прозрачностью
- **Курсор**: Красный курсор воспроизведения
- **Биты**: Белые линии битов (полупрозрачные)
- **Метки цикла**: 
  - Точка A: Зеленая вертикальная линия
  - Точка B: Красная вертикальная линия
  - Область цикла: Полупрозрачная заливка
- **Отклонения битов**: Красные маркеры для нерегулярных битов
- **Питч-сетка**: Сетка высот с метками нот
- **Тема**: Темная тема интерфейса с прямыми краями скроллбаров

## Система команд

### Command Pattern
- `AudioCommand`: Загрузка и сохранение аудио
- `BeatFixCommand`: Исправление отклонений битов
- `QUndoStack`: Управление историей команд
- Поддержка отмены/повтора операций

### Горячие клавиши
- **Основные**: Пробел (воспроизведение), S (стоп), M (метроном)
- **Циклы**: A/B (установка), Shift+A/B (удаление)
- **Навигация**: Стрелки, Ctrl+↑/↓ (BPM)
- **Контекстные меню**: Правый клик на кнопках цикла

## Метроном

### Функциональность
- Синхронизация с BPM трека
- Генерация звуковых сигналов
- Визуальная индикация
- Настраиваемая громкость
- Автоматическое включение/выключение

### Техническая реализация
- `QTimer` для точного тайминга
- `QAudioOutput` для воспроизведения
- Генерация WAV файлов на лету
- Интеграция с системой настроек

## Технические детали

### Масштабирование и прокрутка
- **Масштаб**: 1.0 (100%) до 1000.0 (100000%)
- **Смещение**: 0.0 (начало) до 1.0 (конец)
- **Скроллбар**: Адаптивный размер страницы
- **Сохранение позиции**: Видимая область при масштабировании
- **Панорамирование**: Правый клик + перетаскивание
- **Синхронизация**: WaveformView ↔ PitchGridWidget ↔ ScrollBar
- **Каретки воспроизведения**: Точная синхронизация между волной и питч-сеткой
- **Динамическая прозрачность**: Скроллбар становится почти невидимым (5%) при близости каретки

### Обработка аудио
- **Форматы**: WAV, MP3, FLAC
- **Декодирование**: 32-bit float
- **Нормализация**: Автоматическая по амплитуде
- **Каналы**: Моно/стерео
- **Частота**: 44.1 kHz (рекомендуется)
- **Анализ**: BPM, биты, отклонения

### Анализ BPM
- **Алгоритм**: Mixxx onset detection
- **Параметры**: stepSize=512, windowSize=1024
- **Точность**: Высокая для электронной музыки
- **Визуализация**: Отклонения битов красными маркерами
- **Рекомендации**: Автоматические предложения исправлений

### Управление циклами
- **Метки**: A (начало), B (конец)
- **Визуализация**: Цветные линии и заливка
- **Управление**: Горячие клавиши, кнопки, контекстное меню
- **Синхронизация**: С позицией воспроизведения
- **Валидация**: Проверка корректности диапазона

### Оптимизация
- **Отрисовка**: Только видимая область
- **Агрегация**: Сэмплов при масштабировании
- **Кэширование**: Промежуточных вычислений
- **Обновление**: Плавное обновление интерфейса
- **Память**: Эффективное управление аудиоданными
- **Производительность**: Асинхронная обработка BPM